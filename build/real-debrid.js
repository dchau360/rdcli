'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value" in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _humanize=require('humanize');var _humanize2=_interopRequireDefault(_humanize);var _request=require('request');var _request2=_interopRequireDefault(_request);var _url=require('url');var _url2=_interopRequireDefault(_url);var _requestProgress=require('request-progress');var _requestProgress2=_interopRequireDefault(_requestProgress);var _singleLineLog=require('single-line-log');var _singleLineLog2=_interopRequireDefault(_singleLineLog);var _chalk=require('chalk');var _chalk2=_interopRequireDefault(_chalk);var _fs=require('fs');var _fs2=_interopRequireDefault(_fs);var _config=require('config');var _config2=_interopRequireDefault(_config);require('babel-polyfill');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var SIZE_ID=13;var RealDebrid=function(){function RealDebrid(){_classCallCheck(this,RealDebrid);}_createClass(RealDebrid,[{key:'connect',value:regeneratorRuntime.mark(function connect(username,password){var _this=this;return regeneratorRuntime.wrap(function connect$(_context){while(1){switch(_context.prev=_context.next){case 0:return _context.abrupt('return',new Promise(function(resolve){_request2.default.post(_config2.default.apiBaseUrl+'/oauth/v2/token',{form:{username:username,password:password,client_id:_config2.default.clientId,grant_type:'password'}},function(error,response,body){var bodyParse=JSON.parse(body);if(!bodyParse||bodyParse.error){console.error(_chalk2.default.red(bodyParse.error));process.exit();}console.log(_chalk2.default.cyan('Info:')+' Login Successful');_this.token=bodyParse.access_token;resolve(_this.token);});}));case 1:case 'end':return _context.stop();}}},connect,this);})},{key:'unrestrictLink',value:regeneratorRuntime.mark(function unrestrictLink(link){var _this2=this;return regeneratorRuntime.wrap(function unrestrictLink$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:return _context2.abrupt('return',new Promise(function(resolve){_request2.default.post(_config2.default.apiEndpoint+'/unrestrict/link?auth_token='+_this2.token,{form:{link:link}},function(error,response,body){var bodyParse=JSON.parse(body);if(!bodyParse||bodyParse.error){console.log(_chalk2.default.red('Error: '+bodyParse.error));process.exit();}resolve(bodyParse.download);});}));case 1:case 'end':return _context2.stop();}}},unrestrictLink,this);})},{key:'getInfosTorrent',value:regeneratorRuntime.mark(function getInfosTorrent(id){var _this3=this;return regeneratorRuntime.wrap(function getInfosTorrent$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:return _context3.abrupt('return',new Promise(function(resolve){setTimeout(function(){(0,_request2.default)(_config2.default.apiEndpoint+'/torrents/info/'+id+'?auth_token='+_this3.token,function(error,response,body){var bodyParse=JSON.parse(body);if(!bodyParse||bodyParse.error){console.log(_chalk2.default.red('Error: '+bodyParse.error));process.exit();}resolve(bodyParse);});},_config2.default.requestDelay);}));case 1:case 'end':return _context3.stop();}}},getInfosTorrent,this);})},{key:'getTorrentList',value:regeneratorRuntime.mark(function getTorrentList(){var _this4=this;return regeneratorRuntime.wrap(function getTorrentList$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:return _context4.abrupt('return',new Promise(function(resolve){(0,_request2.default)(_config2.default.apiEndpoint+'/torrents?auth_token='+_this4.token,function(error,response,body){var bodyParse=JSON.parse(body);if(!bodyParse||bodyParse.error){console.log(_chalk2.default.red('Error: '+bodyParse.error));process.exit();}resolve(bodyParse);});}));case 1:case 'end':return _context4.stop();}}},getTorrentList,this);})},{key:'selectFile',value:regeneratorRuntime.mark(function selectFile(id){var _this5=this;var files=arguments.length<=1||arguments[1]===undefined?'all':arguments[1];return regeneratorRuntime.wrap(function selectFile$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:return _context5.abrupt('return',new Promise(function(resolve){_request2.default.post(_config2.default.apiEndpoint+'/torrents/selectFiles/'+id+'?auth_token='+_this5.token,{form:{files:files}},function(error,response,body){if(body){var bodyParse=JSON.parse(body);if(!bodyParse||bodyParse.error){console.log(_chalk2.default.red('Error: no files to select'));process.exit();}}resolve(true);});}));case 1:case 'end':return _context5.stop();}}},selectFile,this);})},{key:'deleteTorrent',value:regeneratorRuntime.mark(function deleteTorrent(id){var _this6=this;return regeneratorRuntime.wrap(function deleteTorrent$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:return _context6.abrupt('return',new Promise(function(resolve){setTimeout(function(){_request2.default.delete(_config2.default.apiEndpoint+'/torrents/delete/'+id+'?auth_token='+_this6.token,{},function(error,response,body){if(body){var bodyParse=JSON.parse(body);if(!bodyParse||bodyParse.error){console.log(_chalk2.default.red('Error: '+bodyParse.error));process.exit();}}resolve(true);});},_config2.default.requestDelay);}));case 1:case 'end':return _context6.stop();}}},deleteTorrent,this);})},{key:'removeHistory',value:regeneratorRuntime.mark(function removeHistory(){var torrents,i;return regeneratorRuntime.wrap(function removeHistory$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:_context7.next=2;return this.getTorrentList();case 2:torrents=_context7.sent;i=0;case 4:if(!(i<torrents.length)){_context7.next=10;break;}_context7.next=7;return this.deleteTorrent(torrents[i].id);case 7:i++;_context7.next=4;break;case 10:case 'end':return _context7.stop();}}},removeHistory,this);})},{key:'convertTorrent',value:regeneratorRuntime.mark(function convertTorrent(torrent){var idTorrent,link,status,progressConvert,infos;return regeneratorRuntime.wrap(function convertTorrent$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:idTorrent=void 0;if(!torrent.match(/^magnet:\?xt=urn:[a-z0-9]+:[a-z0-9]{20,50}/i)){_context8.next=5;break;}_context8.next=4;return this.addMagnet(torrent);case 4:idTorrent=_context8.sent;case 5:if(!_fs2.default.existsSync(torrent)){_context8.next=9;break;}_context8.next=8;return this.addTorrent(torrent);case 8:idTorrent=_context8.sent;case 9:_context8.next=11;return this.selectFile(idTorrent);case 11:link=[];status='wait';progressConvert=0;case 14:if(link.length){_context8.next=25;break;}_context8.next=17;return this.getInfosTorrent(idTorrent);case 17:infos=_context8.sent;status=infos.status;link=infos.links;progressConvert=Number(infos.progress);_singleLineLog2.default.stdout('Convert torrent progress: '+progressConvert+'% ('+status+')\n');if(infos.status==='error'){console.error(_chalk2.default.red('Error: convert failed'));process.exit();}_context8.next=14;break;case 25:if(!link.toString().match(/^http/)){console.error(_chalk2.default.red('Error: convert failed'));process.exit();}return _context8.abrupt('return',link.toString());case 27:case 'end':return _context8.stop();}}},convertTorrent,this);})},{key:'addTorrent',value:regeneratorRuntime.mark(function addTorrent(torrent){var _this7=this;var id,infos;return regeneratorRuntime.wrap(function addTorrent$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:_context9.next=2;return new Promise(function(resolve){_fs2.default.createReadStream(torrent).pipe(_request2.default.put(_config2.default.apiEndpoint+'/torrents/addTorrent?auth_token='+_this7.token,{},function(error,response,body){var bodyParse=JSON.parse(body);if(!bodyParse||bodyParse.error||bodyParse.id.length!==SIZE_ID){console.error(_chalk2.default.red('Error: add torrent failed'));process.exit();}resolve(bodyParse.id);}));});case 2:id=_context9.sent;_context9.next=5;return this.getInfosTorrent(id);case 5:infos=_context9.sent;if(!infos.filename){console.error(_chalk2.default.red('Error: add torrent failed'));process.exit();}return _context9.abrupt('return',id);case 8:case 'end':return _context9.stop();}}},addTorrent,this);})},{key:'addMagnet',value:regeneratorRuntime.mark(function addMagnet(magnet){var _this8=this;var id,infos;return regeneratorRuntime.wrap(function addMagnet$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:_context10.next=2;return new Promise(function(resolve){_request2.default.post(_config2.default.apiEndpoint+'/torrents/addMagnet?auth_token='+_this8.token,{form:{magnet:encodeURI(magnet),host:'uptobox.com'}},function(error,response,body){var bodyParse=JSON.parse(body);if(!bodyParse||bodyParse.error||bodyParse.id.length!==SIZE_ID){console.error(_chalk2.default.red('Error: add magnet failed'));process.exit();}resolve(bodyParse.id);});});case 2:id=_context10.sent;_context10.next=5;return this.getInfosTorrent(id);case 5:infos=_context10.sent;if(!infos.filename){console.error(_chalk2.default.red('Error: add magnet failed'));process.exit();}return _context10.abrupt('return',id);case 8:case 'end':return _context10.stop();}}},addMagnet,this);})},{key:'download',value:function download(link,callback){var filename=unescape(_url2.default.parse(link).pathname.split('/').pop());var destination=process.cwd()+'/'+filename;var progressLink=(0,_requestProgress2.default)((0,_request2.default)(link),{throttle:2000,delay:1000});progressLink.on('progress',function(state){return callback({percent:_humanize2.default.numberFormat(state.percentage*100,1),mbps:_humanize2.default.filesize(state.speed),totalSize:_humanize2.default.filesize(state.size.total),bytesWriting:_humanize2.default.filesize(state.size.transferred),remaining:Math.round(state.time.remaining)});});progressLink.on('error',function(err){callback(err);});progressLink.on('end',function(){var stats=_fs2.default.statSync(destination);if(stats.size<3000){console.error(_chalk2.default.red('Error, retry...'));if(process.env.NODE_ENV!=='dev'){_fs2.default.unlink(destination);}process.exit();}callback('end');});progressLink.pipe(_fs2.default.createWriteStream(destination));}}]);return RealDebrid;}();exports.default=RealDebrid;