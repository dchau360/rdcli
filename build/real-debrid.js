'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value" in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _humanize=require('humanize');var _humanize2=_interopRequireDefault(_humanize);var _request=require('request');var _request2=_interopRequireDefault(_request);var _url=require('url');var _url2=_interopRequireDefault(_url);var _requestProgress=require('request-progress');var _requestProgress2=_interopRequireDefault(_requestProgress);var _chalk=require('chalk');var _chalk2=_interopRequireDefault(_chalk);var _fs=require('fs');var _fs2=_interopRequireDefault(_fs);var _ora=require('ora');var _ora2=_interopRequireDefault(_ora);var _config=require('config');var _config2=_interopRequireDefault(_config);require('babel-polyfill');var _debug=require('debug');var _debug2=_interopRequireDefault(_debug);var _http=require('./http');var _http2=_interopRequireDefault(_http);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var log=(0,_debug2.default)('app');var RealDebrid=function(){function RealDebrid(){_classCallCheck(this,RealDebrid);this.SIZE_ID=13;this.MAX_RETRY=5;this.RETRY_DELAY=30*1000;this.MIN_FILESIZE=3000;this.retry=0;}_createClass(RealDebrid,[{key:'connect',value:regeneratorRuntime.mark(function connect(username,password){var data;return regeneratorRuntime.wrap(function connect$(_context){while(1){switch(_context.prev=_context.next){case 0:log('connect to real-debrid.com');_context.next=3;return _http2.default.post(_config2.default.apiBaseUrl+'/oauth/v2/token',{form:{username:username,password:password,client_id:_config2.default.clientId,grant_type:'password'}});case 3:data=_context.sent;if(data.access_token){console.log(_chalk2.default.cyan('Info:')+' Login Successful');this.token=data.access_token;}case 5:case 'end':return _context.stop();}}},connect,this);})},{key:'unrestrictLink',value:regeneratorRuntime.mark(function unrestrictLink(link){var data;return regeneratorRuntime.wrap(function unrestrictLink$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:log('unrestrict link '+link);_context2.next=3;return _http2.default.post(_config2.default.apiEndpoint+'/unrestrict/link?auth_token='+this.token,{form:{link:link}});case 3:data=_context2.sent;return _context2.abrupt('return',data.download);case 5:case 'end':return _context2.stop();}}},unrestrictLink,this);})},{key:'getInfosTorrent',value:regeneratorRuntime.mark(function getInfosTorrent(id){var data;return regeneratorRuntime.wrap(function getInfosTorrent$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:log('get infos torrent '+id);_context3.next=3;return _http2.default.get(_config2.default.apiEndpoint+'/torrents/info/'+id+'?auth_token='+this.token,_config2.default.requestDelay);case 3:data=_context3.sent;return _context3.abrupt('return',data);case 5:case 'end':return _context3.stop();}}},getInfosTorrent,this);})},{key:'getTorrentList',value:regeneratorRuntime.mark(function getTorrentList(){return regeneratorRuntime.wrap(function getTorrentList$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:log('get torrent list');_context4.next=3;return _http2.default.get(_config2.default.apiEndpoint+'/torrents?auth_token='+this.token);case 3:return _context4.abrupt('return',_context4.sent);case 4:case 'end':return _context4.stop();}}},getTorrentList,this);})},{key:'selectFile',value:regeneratorRuntime.mark(function selectFile(id){var files=arguments.length<=1||arguments[1]===undefined?'all':arguments[1];return regeneratorRuntime.wrap(function selectFile$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:log('select file '+id);_context5.next=3;return _http2.default.post(_config2.default.apiEndpoint+'/torrents/selectFiles/'+id+'?auth_token='+this.token,{form:{files:files}});case 3:case 'end':return _context5.stop();}}},selectFile,this);})},{key:'addTorrent',value:regeneratorRuntime.mark(function addTorrent(torrent){var data,infos;return regeneratorRuntime.wrap(function addTorrent$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:log('add torrent '+torrent);_context6.next=3;return _http2.default.put(_config2.default.apiEndpoint+'/torrents/addTorrent?auth_token='+this.token,torrent);case 3:data=_context6.sent;if(!data.id||data.id.length!==this.SIZE_ID){console.error(_chalk2.default.red('Error: add torrent failed'));process.exit();}_context6.next=7;return this.getInfosTorrent(data.id);case 7:infos=_context6.sent;if(!infos.filename){console.error(_chalk2.default.red('Error: add torrent failed'));process.exit();}return _context6.abrupt('return',data.id);case 10:case 'end':return _context6.stop();}}},addTorrent,this);})},{key:'addMagnet',value:regeneratorRuntime.mark(function addMagnet(magnet){var data,infos;return regeneratorRuntime.wrap(function addMagnet$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:log('add magnet '+magnet);_context7.next=3;return _http2.default.post(_config2.default.apiEndpoint+'/torrents/addMagnet?auth_token='+this.token,{form:{magnet:encodeURI(magnet),host:'uptobox.com'}});case 3:data=_context7.sent;_context7.next=6;return this.getInfosTorrent(data.id);case 6:infos=_context7.sent;if(!infos.filename){console.error(_chalk2.default.red('Error: add magnet failed'));process.exit();}return _context7.abrupt('return',data.id);case 9:case 'end':return _context7.stop();}}},addMagnet,this);})},{key:'waitDuringScan',value:regeneratorRuntime.mark(function waitDuringScan(link){var message,content;return regeneratorRuntime.wrap(function waitDuringScan$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:log('scan anti-virus '+link);message='Please wait until the file has been scanned by our anti-virus';if(!this.spinner){this.spinner=(0,_ora2.default)(message).start();}_context8.next=5;return new Promise(function(resolve){setTimeout(function(){(0,_request2.default)(link,function(error,response,body){resolve(body);});},_config2.default.requestDelay);});case 5:content=_context8.sent;if(!content.match(new RegExp(message))){_context8.next=11;break;}_context8.next=9;return this.waitDuringScan(link);case 9:_context8.next=12;break;case 11:this.spinner.stop();case 12:case 'end':return _context8.stop();}}},waitDuringScan,this);})},{key:'convertTorrent',value:regeneratorRuntime.mark(function convertTorrent(torrent){var idTorrent,link,status,progressConvert,spinner,infos;return regeneratorRuntime.wrap(function convertTorrent$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:log('convert torrent '+torrent);idTorrent=void 0;if(!torrent.match(/^magnet:\?xt=urn:[a-z0-9]+:[a-z0-9]{20,50}/i)){_context9.next=6;break;}_context9.next=5;return this.addMagnet(torrent);case 5:idTorrent=_context9.sent;case 6:if(!_fs2.default.existsSync(torrent)){_context9.next=10;break;}_context9.next=9;return this.addTorrent(torrent);case 9:idTorrent=_context9.sent;case 10:_context9.next=12;return this.selectFile(idTorrent);case 12:link=[];status='wait';progressConvert=0;spinner=(0,_ora2.default)('Convert torrent progress: '+progressConvert+'% ('+status+')').start();case 16:if(link.length){_context9.next=27;break;}_context9.next=19;return this.getInfosTorrent(idTorrent);case 19:infos=_context9.sent;status=infos.status;link=infos.links;progressConvert=Number(infos.progress);spinner.text='Convert torrent progress: '+progressConvert+'% ('+status+')';if(infos.status==='error'){console.error(_chalk2.default.red('Error: convert failed'));process.exit();}_context9.next=16;break;case 27:spinner.stop();if(!link.toString().match(/^http/)){console.error(_chalk2.default.red('Error: convert failed'));process.exit();}if(link.length>1){console.log('Unfortunately rdcli cannot download split files : \n'+link.join('\n'));process.exit();}return _context9.abrupt('return',link.toString());case 31:case 'end':return _context9.stop();}}},convertTorrent,this);})},{key:'download',value:function download(link,callback){var _this=this;log('download file '+link);var filename=unescape(_url2.default.parse(link).pathname.split('/').pop());var file=process.cwd()+'/'+filename;var progressLink=(0,_requestProgress2.default)((0,_request2.default)(link),{throttle:2000,delay:1000});progressLink.on('progress',function(state){return callback({percent:_humanize2.default.numberFormat(state.percentage*100,1),mbps:_humanize2.default.filesize(state.speed),totalSize:_humanize2.default.filesize(state.size.total),bytesWriting:_humanize2.default.filesize(state.size.transferred),remaining:Math.round(state.time.remaining)});});progressLink.on('error',function(){return callback('error');});progressLink.on('end',function(){if(_fs2.default.statSync(file).size<_this.MIN_FILESIZE&&_fs2.default.readFileSync(file,'utf8').match(/error|erreur/gi)){if(_this.retry<_this.MAX_RETRY){_this.retry++;console.log('Error, retry download in '+_this.RETRY_DELAY/1000+'s...');setTimeout(function(){_this.download(link,callback);},_this.RETRY_DELAY);}else {var message=_fs2.default.readFileSync(file,'utf8').match(/danger">([^"]+)<\/div>/);if(message){var error=message[1].replace(/<br\/>/gi,'\n');console.log(error+'\n');console.log('Contact us on https://real-debrid.com/support');}callback('error');}}else {callback('end');}});progressLink.pipe(_fs2.default.createWriteStream(file));}}]);return RealDebrid;}();exports.default=RealDebrid;