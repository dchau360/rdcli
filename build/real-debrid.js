'use strict';Object.defineProperty(exports,"__esModule",{value:true});var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value" in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor);}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor;};}();var _humanize=require('humanize');var _humanize2=_interopRequireDefault(_humanize);var _request=require('request');var _request2=_interopRequireDefault(_request);var _url=require('url');var _url2=_interopRequireDefault(_url);var _requestProgress=require('request-progress');var _requestProgress2=_interopRequireDefault(_requestProgress);var _chalk=require('chalk');var _chalk2=_interopRequireDefault(_chalk);var _ora=require('ora');var _ora2=_interopRequireDefault(_ora);var _fs=require('fs');var _fs2=_interopRequireDefault(_fs);var _config=require('config');var _config2=_interopRequireDefault(_config);require('babel-polyfill');function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function");}}var RealDebrid=function(){function RealDebrid(){_classCallCheck(this,RealDebrid);}_createClass(RealDebrid,[{key:'connect',value:regeneratorRuntime.mark(function connect(username,password){var _this=this;return regeneratorRuntime.wrap(function connect$(_context){while(1){switch(_context.prev=_context.next){case 0:return _context.abrupt('return',new Promise(function(resolve,reject){_request2.default.post(_config2.default.apiBaseUrl+'/oauth/v2/token',{form:{username:username,password:password,client_id:_config2.default.clientId,grant_type:'password'}},function(error,response,body){if(response.statusCode!==200){reject('error response');}var bodyParse=JSON.parse(body);if(bodyParse.error){console.error(_chalk2.default.red(bodyParse.error));process.exit();}console.log(_chalk2.default.cyan('Info:')+' Login Successful');_this.token=bodyParse.access_token;resolve(_this.token);});}));case 1:case 'end':return _context.stop();}}},connect,this);})},{key:'unrestrictLink',value:regeneratorRuntime.mark(function unrestrictLink(link){var _this2=this;return regeneratorRuntime.wrap(function unrestrictLink$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:return _context2.abrupt('return',new Promise(function(resolve,reject){_request2.default.post(_config2.default.apiEndpoint+'/unrestrict/link?auth_token='+_this2.token,{form:{link:link}},function(error,response,body){if(response.statusCode!==200){reject('response error');}var bodyParse=JSON.parse(body);if(bodyParse.error){console.log(_chalk2.default.red(bodyParse.error));reject(bodyParse.error);}resolve(bodyParse.download);});}));case 1:case 'end':return _context2.stop();}}},unrestrictLink,this);})},{key:'getInfosTorrent',value:regeneratorRuntime.mark(function getInfosTorrent(id){var _this3=this;return regeneratorRuntime.wrap(function getInfosTorrent$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:return _context3.abrupt('return',new Promise(function(resolve){setTimeout(function(){(0,_request2.default)(_config2.default.apiEndpoint+'/torrents/info/'+id+'?auth_token='+_this3.token,function(error,response,body){resolve(JSON.parse(body));});},_config2.default.delay);}));case 1:case 'end':return _context3.stop();}}},getInfosTorrent,this);})},{key:'getTorrentList',value:regeneratorRuntime.mark(function getTorrentList(){var _this4=this;return regeneratorRuntime.wrap(function getTorrentList$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:return _context4.abrupt('return',new Promise(function(resolve){(0,_request2.default)(_config2.default.apiEndpoint+'/torrents?auth_token='+_this4.token,function(error,response,body){resolve(JSON.parse(body));});}));case 1:case 'end':return _context4.stop();}}},getTorrentList,this);})},{key:'selectFile',value:regeneratorRuntime.mark(function selectFile(id,files){var _this5=this;return regeneratorRuntime.wrap(function selectFile$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:return _context5.abrupt('return',new Promise(function(resolve){_request2.default.post(_config2.default.apiEndpoint+'/torrents/selectFiles/'+id+'?auth_token='+_this5.token,{form:{files:files}},function(){resolve(true);});}));case 1:case 'end':return _context5.stop();}}},selectFile,this);})},{key:'deleteTorrent',value:regeneratorRuntime.mark(function deleteTorrent(id){var _this6=this;return regeneratorRuntime.wrap(function deleteTorrent$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:return _context6.abrupt('return',new Promise(function(resolve){_request2.default.del(_config2.default.apiEndpoint+'/torrents/delete/'+id+'?auth_token='+_this6.token,{},function(){resolve(true);});}));case 1:case 'end':return _context6.stop();}}},deleteTorrent,this);})},{key:'convertToDdl',value:regeneratorRuntime.mark(function convertToDdl(torrent){var id,torrents,infos,hash,i,link,status,progressConvert,spinner;return regeneratorRuntime.wrap(function convertToDdl$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:id=void 0;_context7.next=3;return this.getTorrentList();case 3:torrents=_context7.sent;if(!_fs2.default.existsSync(torrent)){_context7.next=10;break;}_context7.next=7;return this.addTorrent(torrent);case 7:id=_context7.sent;_context7.next=13;break;case 10:_context7.next=12;return this.addMagnet(torrent);case 12:id=_context7.sent;case 13:_context7.next=15;return this.selectFile(id,'all');case 15:_context7.next=17;return this.getInfosTorrent(id);case 17:infos=_context7.sent;hash=infos.hash;i=0;case 20:if(!(i<torrents.length)){_context7.next=27;break;}if(!(hash===torrents[i].hash)){_context7.next=24;break;}_context7.next=24;return this.deleteTorrent(torrents[i].id);case 24:i++;_context7.next=20;break;case 27:link=void 0;status='wait';progressConvert=0;spinner=(0,_ora2.default)('Convert torrent progress: '+progressConvert+'% ('+status+')');spinner.start();spinner.color='cyan';case 33:if(!(progressConvert<100&&status!=='downloaded')){_context7.next=43;break;}_context7.next=36;return this.getInfosTorrent(id);case 36:infos=_context7.sent;status=infos.status;link=infos.links.toString();spinner.text='Convert torrent progress: '+progressConvert+'% ('+status+')';progressConvert=Number(infos.progress);_context7.next=33;break;case 43:spinner.stop();return _context7.abrupt('return',link);case 45:case 'end':return _context7.stop();}}},convertToDdl,this);})},{key:'addTorrent',value:regeneratorRuntime.mark(function addTorrent(torrent){var _this7=this;return regeneratorRuntime.wrap(function addTorrent$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:return _context8.abrupt('return',new Promise(function(resolve,reject){_fs2.default.createReadStream(torrent).pipe(_request2.default.put(_config2.default.apiEndpoint+'/torrents/addTorrent?auth_token='+_this7.token,{},function(error,response,body){if(response.statusCode!==200){reject('error response');}var bodyParse=JSON.parse(body);if(bodyParse.error){console.error(_chalk2.default.red(bodyParse.error));reject(bodyParse.error);}resolve(bodyParse.id);}));}));case 1:case 'end':return _context8.stop();}}},addTorrent,this);})},{key:'addMagnet',value:regeneratorRuntime.mark(function addMagnet(magnet){var _this8=this;return regeneratorRuntime.wrap(function addMagnet$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:return _context9.abrupt('return',new Promise(function(resolve,reject){_request2.default.post(_config2.default.apiEndpoint+'/torrents/addMagnet?auth_token='+_this8.token,{form:{magnet:magnet,host:'uptobox.com'}},function(error,response,body){var bodyParse=JSON.parse(body);if(bodyParse.error){console.error(_chalk2.default.red(bodyParse.error));reject(bodyParse.error);}resolve(bodyParse.id);});}));case 1:case 'end':return _context9.stop();}}},addMagnet,this);})},{key:'download',value:function download(link,callback){var filename=unescape(_url2.default.parse(link).pathname.split('/').pop());var destination=process.cwd()+'/'+filename;var progressLink=(0,_requestProgress2.default)((0,_request2.default)(link),{throttle:2000,delay:_config2.default.delay});var lastBytesWriting=void 0;progressLink.on('progress',function(state){var chunkSize=state.received-lastBytesWriting;lastBytesWriting=state.received;if(state.percent===100){callback('end');}callback({percent:state.percent,mbps:_humanize2.default.filesize(chunkSize),totalSize:_humanize2.default.filesize(state.total),bytesWriting:_humanize2.default.filesize(state.received)});});progressLink.on('error',function(err){callback(err);});progressLink.on('close',function(){callback('end');});progressLink.pipe(_fs2.default.createWriteStream(destination));}}]);return RealDebrid;}();exports.default=RealDebrid;