'use strict';Object.defineProperty(exports,"__esModule",{value:true});exports.waitDuringScan=waitDuringScan;exports.download=download;var _url=require('url');var _url2=_interopRequireDefault(_url);var _requestProgress=require('request-progress');var _requestProgress2=_interopRequireDefault(_requestProgress);var _humanize=require('humanize');var _humanize2=_interopRequireDefault(_humanize);var _fs=require('fs');var _fs2=_interopRequireDefault(_fs);var _debug=require('debug');var _debug2=_interopRequireDefault(_debug);var _request=require('request');var _request2=_interopRequireDefault(_request);var _ora=require('ora');var _ora2=_interopRequireDefault(_ora);var _config=require('config');var _config2=_interopRequireDefault(_config);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj};}var _marked=[waitDuringScan].map(regeneratorRuntime.mark);var log=(0,_debug2.default)('download');var MAX_RETRY=5;var RETRY_DELAY=30*1000;var MIN_FILESIZE=3000;var retry=0;var spinner=void 0;function waitDuringScan(link){var message,content;return regeneratorRuntime.wrap(function waitDuringScan$(_context){while(1){switch(_context.prev=_context.next){case 0:log('scan anti-virus '+link);message='Please wait until the file has been scanned by our anti-virus';if(!spinner){spinner=(0,_ora2.default)(message).start();}_context.next=5;return new Promise(function(resolve){setTimeout(function(){(0,_request2.default)(link,function(error,response,body){resolve(body);});},_config2.default.requestDelay);});case 5:content=_context.sent;if(!content.match(new RegExp(message))){_context.next=11;break;}_context.next=9;return waitDuringScan(link);case 9:_context.next=12;break;case 11:spinner.stop();case 12:case'end':return _context.stop();}}},_marked[0],this);}function download(link,callback){log('download file '+link);var filename=unescape(_url2.default.parse(link).pathname.split('/').pop());var file=process.cwd()+'/'+filename;var progressLink=(0,_requestProgress2.default)((0,_request2.default)(link),{throttle:2000,delay:1000});progressLink.on('progress',function(state){return callback({percent:_humanize2.default.numberFormat(state.percentage*100,1),mbps:_humanize2.default.filesize(state.speed),totalSize:_humanize2.default.filesize(state.size.total),bytesWriting:_humanize2.default.filesize(state.size.transferred),remaining:Math.round(state.time.remaining)});});progressLink.on('error',function(){return callback('error');});progressLink.on('end',function(){if(_fs2.default.statSync(file).size<MIN_FILESIZE&&_fs2.default.readFileSync(file,'utf8').match(/error|erreur/gi)){if(retry<MAX_RETRY){retry+=1;console.log('Error, retry download in '+RETRY_DELAY/1000+'s...');setTimeout(function(){download(link,callback);},RETRY_DELAY);}else{var message=_fs2.default.readFileSync(file,'utf8').match(/danger">([^"]+)<\/div>/);if(message){var error=message[1].replace(/<br\/>/gi,'\n');console.log(error+'\n');console.log('Contact us on https://real-debrid.com/support');}callback('error');}}else{callback('end');}});progressLink.pipe(_fs2.default.createWriteStream(file));}